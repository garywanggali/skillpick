<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SkillPick | 拾趣</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #ffffff;
            --secondary-color: #bbbbbb;
            --accent-color: #f5a623;
            --text-color: #eeeeee;
            --bg-color: #000000;
            --card-bg: #111111;
            --border-color: #333333;
            --danger-color: #ff4d4d;
            --success-color: #00e676;
            --shadow: none;
            --radius: 0px; /* 棱角分明，移除圆角 */
        }

        body { 
            font-family: 'Noto Sans SC', "Helvetica Neue", Helvetica, Arial, sans-serif; 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 20px; 
            color: var(--text-color); 
            line-height: 1.6; 
            background-color: var(--bg-color); 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Navigation */
        nav { 
            margin-bottom: 30px; 
            background: var(--card-bg); 
            padding: 15px 25px; 
            border: 1px solid var(--border-color); /* 细线条边框 */
            border-radius: var(--radius); 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            flex-wrap: wrap; 
        }
        
        .logo { 
            font-size: 1.5rem; 
            font-weight: 300; 
            color: var(--primary-color); 
            text-decoration: none; 
            margin-right: auto; 
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: 2px;
        }
        
        .logo i { color: var(--primary-color); font-size: 1.2rem; }
        
        .nav-links { display: flex; align-items: center; gap: 25px; flex-wrap: wrap; }
        .nav-links a { 
            text-decoration: none; 
            color: #888; 
            font-weight: 300; 
            font-size: 0.9rem; 
            transition: color 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            letter-spacing: 1px;
        }
        .nav-links a:hover { color: var(--primary-color); }
        .nav-links a.active { color: var(--primary-color); font-weight: 500; border-bottom: 1px solid white; padding-bottom: 2px; }
        
        /* Buttons */
        .btn { 
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 20px; 
            background: transparent; 
            color: white; 
            text-decoration: none; 
            border-radius: var(--radius); 
            border: 1px solid white; 
            cursor: pointer; 
            font-size: 0.9rem; 
            font-weight: 300;
            transition: all 0.2s ease; 
            letter-spacing: 1px;
        }
        .btn:hover { background: white; color: black; }
        
        .btn-success { border-color: var(--success-color); color: var(--success-color); }
        .btn-success:hover { background: var(--success-color); color: black; }
        
        .btn-danger { border-color: var(--danger-color); color: var(--danger-color); }
        .btn-danger:hover { background: var(--danger-color); color: white; }
        
        .btn-sm { padding: 4px 12px; font-size: 0.8rem; }
        
        .btn-outline { 
            background: transparent; 
            border: 1px solid #555; 
            color: #888; 
        }
        .btn-outline:hover { 
            background: #222; 
            color: white; 
            border-color: white; 
        }
        
        /* Cards */
        .card { 
            border: 1px solid var(--border-color); 
            padding: 25px; 
            margin-bottom: 20px; 
            border-radius: var(--radius); 
            background: var(--card-bg); 
            box-shadow: none;
        }
        
        /* Forms */
        form p { margin-bottom: 25px; }
        label { display: block; margin-bottom: 10px; font-weight: 300; color: #aaa; font-size: 0.9rem; letter-spacing: 1px; }
        input[type="text"], input[type="password"], textarea, select, input[type="number"] { 
            width: 100%; 
            padding: 12px 15px; 
            box-sizing: border-box; 
            margin-bottom: 5px; 
            border: 1px solid #333; 
            border-radius: 0; 
            font-size: 1rem; 
            transition: border-color 0.2s;
            -webkit-appearance: none; 
            background: #000;
            color: white;
            font-family: inherit;
        }
        input:focus, textarea:focus { 
            border-color: white; 
            outline: none; 
            background: #111;
        }
        
        .helptext { font-size: 0.8em; color: #666; display: block; margin-top: 5px; }
        ul.errorlist { color: var(--danger-color); list-style: none; padding: 0; margin-bottom: 15px; font-size: 0.9em; }

        /* Footer */
        footer {
            margin-top: auto;
            text-align: center;
            padding: 40px 0;
            color: #444;
            font-size: 0.8em;
            letter-spacing: 1px;
            border-top: 1px solid #111;
        }

        /* Mobile specific adjustments */
        @media (max-width: 600px) {
            body { padding: 15px; }
            nav { flex-direction: column; align-items: flex-start; gap: 20px; padding: 20px; }
            .nav-links { width: 100%; justify-content: flex-start; gap: 20px; margin-top: 5px; overflow-x: auto; padding-bottom: 10px; }
            .nav-links::-webkit-scrollbar { display: none; }
            .nav-links a { font-size: 0.85rem; white-space: nowrap; padding: 5px 10px; border: 1px solid #333; }
            .nav-links a.active { border-color: white; color: white; background: transparent; }
            
            .card { padding: 20px; }
            .btn-block-mobile { display: flex; width: 100%; box-sizing: border-box; margin-bottom: 15px; }
            
            h1 { font-size: 1.8em; }
            h2 { font-size: 1.5em; }
            h3 { font-size: 1.3em; }
            
            .hide-mobile { display: none !important; }
            .show-mobile { display: block !important; }
        }
        
        @media (min-width: 601px) {
            .show-mobile { display: none !important; }
        }
    </style>
</head>
<body>
    <nav>
        <a href="{% url 'dashboard' %}" class="logo">
            <i class="fa-solid fa-square-full" style="font-size: 0.8em; transform: rotate(45deg);"></i>
            SKILLPICK <span style="font-weight: 300; color: #555; font-size: 0.8em; margin-left: 10px;">| 拾趣</span>
        </a>
        <div class="nav-links">
            <a href="{% url 'dashboard' %}">看板</a>
            {% if user.is_authenticated %}
                <a href="{% url 'daily_pick' %}">今日学习</a>
                <a href="{% url 'topic_add' %}">新建</a>
                <a href="{% url 'refresh_rec' %}" onclick="return confirm('确定要刷新今日推荐吗？')">刷新</a>
                <form action="{% url 'logout' %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" style="border:none; background:none; cursor:pointer; color:#888; font-size: 0.9rem; padding: 0; display: flex; align-items: center; gap: 5px; font-weight: 300; letter-spacing: 1px;">
                        退出
                    </button>
                </form>
            {% else %}
                <a href="{% url 'login' %}">登录</a>
                <a href="{% url 'register' %}" class="btn btn-sm" style="color: white; border-color: white;">注册</a>
            {% endif %}
        </div>
    </nav>
    <main>
        {% block content %}{% endblock %}
    </main>
    <footer>
        <p>&copy; {% now "Y" %} SKILLPICK | 拾趣. LESS IS MORE. <a href="{% url 'reset_popup' %}" style="color: #333; text-decoration: none; margin-left: 10px;">[重置提醒]</a></p>
    </footer>

    <!-- Daily Popup Modal -->
    <div id="daily-popup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: #111; border: 1px solid #333; padding: 30px; width: 90%; max-width: 400px; text-align: center; position: relative;">
            <h3 style="color: #fff; margin-top: 0; font-weight: 300;">今日学习提醒</h3>
            <div id="popup-content">
                <i class="fa-solid fa-spinner fa-spin" style="font-size: 2em; color: #666; margin: 20px 0;"></i>
                <p style="color: #888;">正在为您抽取今日内容...</p>
            </div>
        </div>
    </div>

    {% if user.is_authenticated %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Request Notification Permission on load
            if ("Notification" in window) {
                if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                    Notification.requestPermission().then(permission => {
                        console.log("Notification permission:", permission);
                    });
                }
            }

            // Check Daily Popup
            fetch("{% url 'api_check_popup' %}")
            .then(response => response.json())
            .then(data => {
                if (data.show) {
                    const popup = document.getElementById('daily-popup');
                    const content = document.getElementById('popup-content');
                    
                    // 1. Show web modal
                    popup.style.display = 'flex';
                    
                    content.innerHTML = `
                        <h2 style="color: #fff; margin: 15px 0;">${data.topic}</h2>
                        <p style="color: #aaa; font-size: 0.9em; margin-bottom: 25px;">${data.reason}</p>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="handlePopup('rejected')" class="btn btn-outline" style="border-color: #444; color: #666;">滚，今天算了</button>
                            <button onclick="handlePopup('accepted', '${data.url}')" class="btn btn-success">行吧，去看看</button>
                        </div>
                    `;

                    // 2. Trigger System Notification
                    if ("Notification" in window && Notification.permission === "granted") {
                        const notification = new Notification("SkillPick 今日推荐", {
                            body: `${data.topic}：${data.reason}`,
                            icon: "https://cdn-icons-png.flaticon.com/512/2991/2991148.png", // 这里的图标可以换成你自己的 logo url
                            requireInteraction: true // 让通知一直显示直到用户点击
                        });
                        
                        notification.onclick = function() {
                            window.focus();
                            handlePopup('accepted', data.url);
                            notification.close();
                        };
                    }
                }
            });
        });

        function handlePopup(action, url) {
            fetch("{% url 'api_record_popup' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `action=${action}`
            })
            .then(() => {
                document.getElementById('daily-popup').style.display = 'none';
                if (action === 'accepted' && url) {
                    window.location.href = url;
                }
            });
        }
    </script>
    {% endif %}
</body>
</html>
